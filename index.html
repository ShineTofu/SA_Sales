<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Selling Agent Daily Sales Tool</title>

<!-- PWA (offline) -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#028b43">

<style>
:root{
  --beige:#f6f3dd;
  --green:#028b43;
  --orange:#f8a925;
  --bg:var(--beige);
  --text:#0b1220;
  --muted:#475569;
  --card:#ffffff;
  --border:#e5e7eb;
}

body{
  margin:0;
  font-family: Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:600px;
  margin:auto;
  padding:15px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

h2{ margin-top:0; }
label{ font-size:14px; font-weight:bold; }

input, select{
  width:100%;
  padding:10px;
  margin-top:5px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
}

button{
  padding:10px 15px;
  border-radius:20px;
  border:none;
  font-weight:bold;
  cursor:pointer;
}

.btn-primary{ background:var(--green); color:white; }
.btn-orange{ background:var(--orange); color:black; }
.btn-secondary{ background:white; border:1px solid var(--border); }

.flex{ display:flex; gap:10px; flex-wrap:wrap; }

.table-container{ overflow-x:auto; }

table{
  border-collapse:collapse;
  width:100%;
  font-size:13px;
}

th, td{
  padding:8px;
  border:1px solid var(--border);
  text-align:left;
}

th{ background:#eee5d8; }

.error{ color:red; font-size:13px; }
.warning{ color:#b45309; font-size:13px; }
</style>
</head>

<body>
<div class="container">

<!-- TOUT LE HTML RESTE IDENTIQUE -->

<script>
/* =====================
   Offline (PWA) enable
   ===================== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js", { scope: "./" });
}

const today = new Date().toISOString().split("T")[0];
document.getElementById("date").value = today;

const productSelect = document.getElementById("product");
const price = document.getElementById("price");
const weight = document.getElementById("weight");

const districtSelect = document.getElementById("district");
const parishSelect = document.getElementById("parishSelect");
const parishInput = document.getElementById("parishInput");

const soldKg = document.getElementById("soldKg");
const warnMsg = document.getElementById("warnMsg");
const errorMsg = document.getElementById("errorMsg");

/* =====================
   Hoima parish dropdown
   ===================== */
const hoimaParishes = [
  "Kasingo ward",
  "Kihuukya ward",
  "Kiduuma ward",
  "Kibingo ward",
  "Karongo ward",
  "Bujuura ward",
  "Kyesiiga ward",
  "Kihombooza ward",
  "Western ward Hoima",
  "Kicwamba ward",
  "Kyentale ward",
  "Nyakambugu ward",
  "Bwikya ward",
  "Northern ward Hoima",
  "Southern ward Hoima",
  "Central ward Hoima",
  "Kibugubya"
].sort((a,b)=>a.localeCompare(b));

function setupHoimaParishOptions(){
  parishSelect.innerHTML = '<option value="">Select</option>';
  hoimaParishes.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    parishSelect.appendChild(opt);
  });
}
setupHoimaParishOptions();

function updateParishField(){
  if(districtSelect.value === "Hoima"){
    parishInput.style.display = "none";
    parishSelect.style.display = "block";
  } else {
    parishSelect.style.display = "none";
    parishInput.style.display = "block";
  }
}

function getParishValue(){
  return (districtSelect.value === "Hoima") ? (parishSelect.value || "") : (parishInput.value || "");
}

districtSelect.addEventListener("change", ()=>{
  updateParishField();
  calculate();
});
updateParishField();

/* =====================
   Product price/weight
   ===================== */
productSelect.addEventListener("change", ()=>{
  if(productSelect.value==="Skewer"){
    price.value=1000;
    weight.value=0.045;
  } else if(productSelect.value==="Kikalayi"){
    price.value=500;
    weight.value=0.040;
  } else {
    price.value="";
    weight.value="";
  }
  calculate();
});

function formatUGX(n){
  return Number(n||0).toLocaleString();
}

function calculate(){
  const w = parseFloat(weight.value)||0;

  let issuedP = parseFloat(issuedPortions.value)||0;
  let issuedK = parseFloat(issuedKg.value)||0;
  let closingP = parseFloat(closingPortions.value)||0;
  let closingK = parseFloat(closingKg.value)||0;

  if(document.activeElement===issuedPortions){
    issuedKg.value = (issuedP*w).toFixed(1);
  }
  if(document.activeElement===issuedKg){
    issuedPortions.value = Math.round(issuedK/w||0);
  }
  if(document.activeElement===closingPortions){
    closingKg.value = (closingP*w).toFixed(1);
  }
  if(document.activeElement===closingKg){
    closingPortions.value = Math.round(closingK/w||0);
  }

  issuedP = parseFloat(issuedPortions.value)||0;
  closingP = parseFloat(closingPortions.value)||0;
  issuedK = parseFloat(issuedKg.value)||0;
  closingK = parseFloat(closingKg.value)||0;

  const soldP = issuedP - closingP;
  const soldK = issuedK - closingK;

  soldKg.value = (soldK || 0).toFixed(1);

  if(soldP < 0){
    errorMsg.innerText="Error: Closing balance cannot exceed issued stock.";
    warnMsg.innerText="";
    return;
  } else {
    errorMsg.innerText="";
  }

  const expected = soldP * (parseFloat(price.value)||0);
  const collected = parseFloat(cashCollected.value)||0;
  const discrepancyVal = expected - collected;

  const rate = (parseFloat(commissionRate.value)||0)/100;

  /* ===== MODIFICATION ICI ===== */
  const commissionVal = (collected * rate) - discrepancyVal;
  /* ============================= */

  warnMsg.innerText = "";
  if (soldK < 2 && soldK > 0) {
    warnMsg.innerText = "Warning: less than 2kg sold.";
  }

  cashExpected.value = formatUGX(expected);
  discrepancy.value = formatUGX(discrepancyVal);
  commission.value = formatUGX(commissionVal);
}

document.querySelectorAll("input").forEach(i=>i.addEventListener("input",calculate));
document.querySelectorAll("select").forEach(s=>s.addEventListener("change",calculate));

</script>
</body>
</html>
